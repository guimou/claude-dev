#!/bin/bash
# Claude Code Development Container Launch Script
# Launches a containerized Claude Code environment with the current directory mounted

set -e

# Configuration
REGISTRY="quay.io"
REGISTRY_IMAGE="guimou/ccbox"
FULL_REGISTRY_IMAGE="${REGISTRY}/${REGISTRY_IMAGE}"
LOCAL_IMAGE_NAME="ccbox"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Generate a unique session identifier
generate_session_id() {
    cat /proc/sys/kernel/random/uuid | cut -c1-8
}

# Generate a unique container name based on workspace directory
# If session_id is provided, appends it for multi-session support
generate_container_name() {
    local workspace_dir="$1"
    local session_id="$2"
    local project_name
    project_name=$(basename "$workspace_dir")
    # Sanitize: lowercase, replace invalid chars with dashes
    project_name=$(echo "$project_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
    # Add short hash of full path for uniqueness (handles same-named dirs)
    local path_hash
    path_hash=$(echo -n "$workspace_dir" | md5sum | cut -c1-8)

    if [[ -n "$session_id" ]]; then
        echo "ccbox-${project_name}-${path_hash}-${session_id}"
    else
        echo "ccbox-${project_name}-${path_hash}"
    fi
}

# Setup project-specific directories under ~/.claude/ccbox-projects/
# Returns the path to the project-specific directory
setup_project_dirs() {
    local workspace_dir="$1"
    local config_dir="$2"
    local project_name
    project_name=$(basename "$workspace_dir")
    # Sanitize project name: lowercase, replace invalid chars
    project_name=$(echo "$project_name" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g')
    local path_hash
    path_hash=$(echo -n "$workspace_dir" | md5sum | cut -c1-8)
    local project_dir="${config_dir}/ccbox-projects/${project_name}_${path_hash}"

    mkdir -p "${project_dir}/projects/-workspace"
    mkdir -p "${project_dir}/todos"
    mkdir -p "${project_dir}/plans"
    mkdir -p "${project_dir}/tasks"
    mkdir -p "${project_dir}/plugins"
    touch "${project_dir}/history.jsonl"

    echo "$project_dir"
}

# Ensure global config files and directories exist
ensure_global_config() {
    local config_dir="$1"
    # Settings and credentials
    [[ -f "${config_dir}/settings.json" ]] || echo '{}' > "${config_dir}/settings.json"
    [[ -f "${config_dir}/settings.local.json" ]] || echo '{}' > "${config_dir}/settings.local.json"
    [[ -f "${config_dir}/.credentials.json" ]] || echo '{}' > "${config_dir}/.credentials.json"
    [[ -f "${config_dir}/keybindings.json" ]] || echo '{"bindings":[]}' > "${config_dir}/keybindings.json"
    # Global memory file (empty is fine)
    [[ -f "${config_dir}/CLAUDE.md" ]] || touch "${config_dir}/CLAUDE.md"
    # Directories
    [[ -d "${config_dir}/statsig" ]] || mkdir -p "${config_dir}/statsig"
    [[ -d "${config_dir}/hooks" ]] || mkdir -p "${config_dir}/hooks"
    [[ -d "${config_dir}/commands" ]] || mkdir -p "${config_dir}/commands"
    [[ -d "${config_dir}/skills" ]] || mkdir -p "${config_dir}/skills"
    [[ -d "${config_dir}/agents" ]] || mkdir -p "${config_dir}/agents"
    [[ -d "${config_dir}/rules" ]] || mkdir -p "${config_dir}/rules"
}

# Show first-run message for new project directories
migrate_if_needed() {
    local project_dir="$1"
    local config_dir="$2"

    # Only show message if project dir is new AND old structure exists
    if [[ ! -f "${project_dir}/.migrated" && -f "${config_dir}/history.jsonl" ]]; then
        log_info "First run with project isolation for this workspace."
        if [[ -f "${config_dir}/.credentials.json" ]]; then
            log_info "Credentials will be shared across all projects."
        fi
        touch "${project_dir}/.migrated"
        log_info "Project-specific data stored in: ${project_dir}"
    fi
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Parse arguments
BUILD_ONLY=false
USE_LOCAL=false
NO_FIREWALL=true
NO_CLIPBOARD=false
LIST_SESSIONS=false
CLAUDE_VERSION=""
NPM_GLOBAL=""
EXTRA_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --build)
            BUILD_ONLY=true
            shift
            ;;
        --local)
            USE_LOCAL=true
            shift
            ;;
        --claude-version)
            CLAUDE_VERSION="$2"
            shift 2
            ;;
        --claude-version=*)
            CLAUDE_VERSION="${1#*=}"
            shift
            ;;
        --with-firewall)
            NO_FIREWALL=false
            shift
            ;;
        --list-sessions)
            LIST_SESSIONS=true
            shift
            ;;
        --no-clipboard)
            NO_CLIPBOARD=true
            shift
            ;;
        --npm-global)
            NPM_GLOBAL="$2"
            shift 2
            ;;
        --npm-global=*)
            NPM_GLOBAL="${1#*=}"
            shift
            ;;
        --)
            shift
            EXTRA_ARGS=("$@")
            break
            ;;
        -h|--help)
            echo "Usage: $(basename "$0") [OPTIONS] [-- CLAUDE_ARGS...]"
            echo ""
            echo "Run Claude Code in a container. By default, pulls from ${FULL_REGISTRY_IMAGE}."
            echo ""
            echo "Options:"
            echo "  --build                  Build image locally (for development)"
            echo "  --local                  Use locally-built image instead of pulling"
            echo "  --claude-version VERSION Use specific Claude Code version"
            echo "  --with-firewall          Enable network firewall restrictions"
            echo "  --no-clipboard           Disable clipboard access (for extra security)"
            echo "  --npm-global PATH        Mount npm global prefix (auto-detected if not set)"
            echo "  --list-sessions          List active sessions for this project"
            echo "  -h, --help               Show this help message"
            echo ""
            echo "Examples:"
            echo "  $(basename "$0")                              # Pull latest and run"
            echo "  $(basename "$0") --claude-version 2.1.29      # Pull specific version"
            echo "  $(basename "$0") --local                      # Use local image"
            echo "  $(basename "$0") --build                      # Build locally"
            echo "  $(basename "$0") --with-firewall              # Run with network restrictions"
            echo "  $(basename "$0") -- --version                 # Pass args to claude"
            exit 0
            ;;
        *)
            EXTRA_ARGS+=("$1")
            shift
            ;;
    esac
done

# Check if podman is available
if ! command -v podman &> /dev/null; then
    log_error "podman is not installed or not in PATH"
    exit 1
fi

# Handle --list-sessions early (doesn't need image)
if $LIST_SESSIONS; then
    WORKSPACE_DIR="$(pwd)"
    BASE_NAME=$(generate_container_name "$WORKSPACE_DIR")
    log_info "Active sessions for: $(basename "$WORKSPACE_DIR")"
    podman ps --filter "name=^${BASE_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.CreatedAt}}"
    exit 0
fi

# Read version from CLAUDE_VERSION file if not specified via command line
read_version_file() {
    local version_file="${SCRIPT_DIR}/CLAUDE_VERSION"
    if [[ -f "$version_file" ]]; then
        local version
        version=$(tr -d '[:space:]' < "$version_file")
        if [[ -n "$version" && "$version" != "latest" ]]; then
            echo "$version"
        fi
    fi
}

# Determine image tag based on CLI arg, CLAUDE_VERSION file, or default to latest
determine_image_tag() {
    local tag="${CLAUDE_VERSION}"
    if [[ -z "$tag" ]]; then
        tag=$(read_version_file)
    fi
    if [[ -z "$tag" ]]; then
        tag="latest"
    fi
    echo "$tag"
}

# Pull image from registry
pull_image() {
    local image_ref="$1"
    log_info "Pulling image: $image_ref"
    if ! podman pull "$image_ref"; then
        log_error "Failed to pull image: $image_ref"
        log_error "To build locally instead: $(basename "$0") --build"
        return 1
    fi
}

# Build image locally
build_image() {
    local tag
    tag=$(determine_image_tag)
    local full_tag="${LOCAL_IMAGE_NAME}:${tag}"

    log_info "Building container image: $full_tag"
    BUILD_ARGS=()

    if [[ "$tag" != "latest" ]]; then
        log_info "Using Claude Code version: $tag"
        BUILD_ARGS+=(--build-arg "CLAUDE_VERSION=${tag}")
    else
        log_info "Using latest Claude Code version"
    fi

    podman build "${BUILD_ARGS[@]}" -t "$full_tag" "$SCRIPT_DIR"

    # Also tag as latest for convenience
    if [[ "$tag" != "latest" ]]; then
        podman tag "$full_tag" "${LOCAL_IMAGE_NAME}:latest"
    fi

    log_info "Image built successfully: $full_tag"
}

if $BUILD_ONLY; then
    build_image
    exit 0
fi

# Determine image tag and reference
IMAGE_TAG=$(determine_image_tag)

if $USE_LOCAL; then
    # Local mode: use locally-built image
    IMAGE_REF="${LOCAL_IMAGE_NAME}:${IMAGE_TAG}"
    if ! podman image exists "$IMAGE_REF"; then
        log_error "Local image '$IMAGE_REF' not found"
        log_error "Build it with: $(basename "$0") --build"
        exit 1
    fi
    log_info "Using local image: $IMAGE_REF"
else
    # Registry mode: pull from quay.io
    IMAGE_REF="${FULL_REGISTRY_IMAGE}:${IMAGE_TAG}"
    if ! pull_image "$IMAGE_REF"; then
        exit 1
    fi
fi

# Prepare mount points
WORKSPACE_DIR="$(pwd)"
SESSION_ID=$(generate_session_id)
CONTAINER_NAME=$(generate_container_name "$WORKSPACE_DIR" "$SESSION_ID")
CLAUDE_CONFIG_DIR="${HOME}/.claude"
GOOGLE_CONFIG_DIR="${HOME}/.config/gcloud"

# Ensure claude config directory exists
if [[ ! -d "$CLAUDE_CONFIG_DIR" ]]; then
    log_info "Creating Claude config directory: $CLAUDE_CONFIG_DIR"
    mkdir -p "$CLAUDE_CONFIG_DIR"
fi

# Ensure global config files exist
ensure_global_config "$CLAUDE_CONFIG_DIR"

# Setup project-specific directories
PROJECT_DATA_DIR=$(setup_project_dirs "$WORKSPACE_DIR" "$CLAUDE_CONFIG_DIR")
migrate_if_needed "$PROJECT_DATA_DIR" "$CLAUDE_CONFIG_DIR"

# Auto-detect npm global prefix if not explicitly set
if [[ -z "$NPM_GLOBAL" ]]; then
    NPM_GLOBAL=$(npm config get prefix 2>/dev/null || echo "")
fi

# Build podman run arguments
PODMAN_ARGS=(
    --rm
    -it
    --name "$CONTAINER_NAME"
    --hostname ccbox
    --userns=keep-id:uid=1000,gid=1000
    -e PROJECT_NAME="$(basename "$WORKSPACE_DIR")"
    -v "${WORKSPACE_DIR}:/workspace:z"
    # Global settings (shared across all projects)
    -v "${CLAUDE_CONFIG_DIR}/settings.json:/home/claude/.claude/settings.json:z"
    -v "${CLAUDE_CONFIG_DIR}/settings.local.json:/home/claude/.claude/settings.local.json:z"
    -v "${CLAUDE_CONFIG_DIR}/.credentials.json:/home/claude/.claude/.credentials.json:z"
    -v "${CLAUDE_CONFIG_DIR}/keybindings.json:/home/claude/.claude/keybindings.json:z"
    -v "${CLAUDE_CONFIG_DIR}/CLAUDE.md:/home/claude/.claude/CLAUDE.md:z"
    -v "${CLAUDE_CONFIG_DIR}/statsig:/home/claude/.claude/statsig:z"
    -v "${CLAUDE_CONFIG_DIR}/hooks:/home/claude/.claude/hooks:z"
    -v "${CLAUDE_CONFIG_DIR}/commands:/home/claude/.claude/commands:z"
    -v "${CLAUDE_CONFIG_DIR}/skills:/home/claude/.claude/skills:z"
    -v "${CLAUDE_CONFIG_DIR}/agents:/home/claude/.claude/agents:z"
    -v "${CLAUDE_CONFIG_DIR}/rules:/home/claude/.claude/rules:z"
    # Project-specific data (isolated per project)
    -v "${PROJECT_DATA_DIR}/history.jsonl:/home/claude/.claude/history.jsonl:z"
    -v "${PROJECT_DATA_DIR}/projects/-workspace:/home/claude/.claude/projects/-workspace:z"
    -v "${PROJECT_DATA_DIR}/todos:/home/claude/.claude/todos:z"
    -v "${PROJECT_DATA_DIR}/plans:/home/claude/.claude/plans:z"
    -v "${PROJECT_DATA_DIR}/tasks:/home/claude/.claude/tasks:z"
    -v "${PROJECT_DATA_DIR}/plugins:/home/claude/.claude/plugins:z"
    # Other config files
    -v "${HOME}/.claude.json:/home/claude/.claude.json:z"
    -v "${GOOGLE_CONFIG_DIR}:/home/claude/.config/gcloud:ro,z"
    -v "${HOME}/.gitconfig:/home/claude/.gitconfig:ro,z"
    -v "${XDG_RUNTIME_DIR}/pulse/native:${XDG_RUNTIME_DIR}/pulse/native:z"
    -v /etc/localtime:/etc/localtime:ro
    -e PULSE_SERVER="unix:${XDG_RUNTIME_DIR}/pulse/native"
    -e TZ="${TZ:-$(cat /etc/timezone 2>/dev/null || timedatectl show -p Timezone --value 2>/dev/null || echo UTC)}"
    -e CLAUDE_CODE_USE_VERTEX="${CLAUDE_CODE_USE_VERTEX}"
    -e ANTHROPIC_VERTEX_PROJECT_ID="${ANTHROPIC_VERTEX_PROJECT_ID}"
    -e "TERM=${TERM:-xterm-256color}"
    -e "LANG=${LANG:-C.UTF-8}"
    -w /workspace
)

# Add status line script if it exists
if [[ -f "${CLAUDE_CONFIG_DIR}/status-line.sh" ]]; then
    PODMAN_ARGS+=(-v "${CLAUDE_CONFIG_DIR}/status-line.sh:/home/claude/.claude/status-line.sh:ro,z")
fi

# Clipboard/display access for image pasting (CTRL+V)
if ! $NO_CLIPBOARD; then
    if [[ -n "$WAYLAND_DISPLAY" && -S "${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}" ]]; then
        # Wayland clipboard access
        PODMAN_ARGS+=(
            -v "${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}:${XDG_RUNTIME_DIR}/${WAYLAND_DISPLAY}:ro"
            -e "WAYLAND_DISPLAY=${WAYLAND_DISPLAY}"
            -e "XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR}"
        )
    elif [[ -n "$DISPLAY" && -d /tmp/.X11-unix ]]; then
        # X11 clipboard access
        PODMAN_ARGS+=(
            -v "/tmp/.X11-unix:/tmp/.X11-unix:ro"
            -e "DISPLAY=${DISPLAY}"
        )
        if [[ -f "${HOME}/.Xauthority" ]]; then
            PODMAN_ARGS+=(-v "${HOME}/.Xauthority:/home/claude/.Xauthority:ro,z")
        fi
    fi
fi

# Mount npm global packages (read-only) if available and not a system directory
if [[ -n "$NPM_GLOBAL" && "$NPM_GLOBAL" != "/usr" && "$NPM_GLOBAL" != "/usr/local" && -d "$NPM_GLOBAL" ]]; then
    PODMAN_ARGS+=(-v "${NPM_GLOBAL}:/home/claude/.npm-global:ro,z")
fi

# Add firewall capabilities if firewall is enabled
if ! $NO_FIREWALL; then
    PODMAN_ARGS+=(
        --cap-add=NET_ADMIN
        --cap-add=NET_RAW
    )
fi

# Determine what command to run
if $NO_FIREWALL; then
    PODMAN_ARGS+=("$IMAGE_REF" claude "${EXTRA_ARGS[@]}")
else
    # Start with firewall initialization, then run claude
    PODMAN_ARGS+=("$IMAGE_REF" /bin/bash -c "sudo /usr/local/bin/init-firewall.sh && exec claude ${EXTRA_ARGS[*]}")
fi

log_info "Starting Claude Code container..."
log_info "Workspace: $WORKSPACE_DIR"
log_info "Session: $SESSION_ID"
log_info "Firewall: $(if $NO_FIREWALL; then echo 'disabled'; else echo 'enabled'; fi)"
log_info "Clipboard: $(if $NO_CLIPBOARD; then echo 'disabled'; else echo 'enabled'; fi)"

# Run the container
exec podman run "${PODMAN_ARGS[@]}"
